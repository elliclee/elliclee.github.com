---
layout: post
title: 什么是 Javascript 闭包？
category: tech
---

在 Windows 8 的 HTML5/JS 应用开发中，使用 JS 时经常要接触到闭包<code>Closure</code>这个概念，总结一下自己学习时的记录。

### 变量作用域 ###
每种语言中的变量都有相对应的作用域定义，基本上都是两种：全局变量以及局部变量，例如下面的代码段
```
var n = 1; //全局变量
function f(){
	alert(n);
}
``` 

```
function f(){
	var n =1; //局部变量
}
alert(n);// 出错

```
这时要注意，在函数内部声明变量时需要使用 var 声明，否则，这个变量是全局变量。

### 什么是闭包 ###
比较正式的定义是：所谓<code>闭包</code>，指的是一个拥有许多变量和绑定了这些变量的环境的表达式（通常是一个函数），因而这些变量也是该表达式的一部分。

这定义看起来过于正式了些。

参考了[阮一峰](http://www.ruanyifeng.com/blog/2009/08/learning_javascript_closures.html)的介绍，自己的认识如下，首先从 JS 代码入手：
```
function f1(){
	var n=999;
	n += 1;
	function f2(){
		alert(n); 
	}
　　return f2;
}
var result=f1();
result(); // 999
```
这段代码有两个特点：

- f2 函数在 f1 函数内部，f2 函数可以访问定义在 f1 的局部变量;
- f1 返回函数 f2;

上面代码中的 f2 就是闭包。

`由于在Javascript语言中，只有函数内部的子函数才能读取局部变量，因此可以把闭包简单理解成"定义在一个函数内部的函数"。`

即是说，当函数 f1 的内部函数 f2 被函数 f1 外的一个变量引用时，就创建了一个闭包。

`在本质上，闭包就是将函数内部和函数外部连接起来的一座桥梁。`

### 闭包的作用 ###
`闭包可以用在许多地方。它的最大用处有两个，一个是前面提到的可以读取函数内部的变量，另一个就是让这些变量的值始终保持在内存中。`

这个怎么理解呢？看回上面的代码，第一次调用`result()`时输出999，如果再调用`result()`时输出的是1000，说明，这些变量是始终保存在内存中。

因为	`var result = f1()`，这里的 result 是全局变量，f2被赋予到一个全局变量中，而 f2 的值依赖于f1，所以f1保持在内存中，不会被 GC 回收。

我们把上面的代码修改成：
```
function f1(){
	var n=999;
	addF = function { n += 1;}
	function f2(){ 
		alert(n); 
	}
　　return f2;
}
var result=f1();
result(); // 999
addF();
result(); // 1000
```
`在 addF 前面没有使用 var 关键字，因此 addF 是一个全局变量，而不是局部变量。其次，addF 的值是一个匿名函数（anonymous function），而这个匿名函数本身也是一个闭包，所以 addF 相当于是一个 Setter，可以在函数外部对函数内部的局部变量进行操作。`

### 应用场景 ###
在Windows 8 应用开发中，JS 代码都被处理成
```
(funcion(){ 
	//code 
})();
```
这样可以避命名污染，也起到保护函数内变量安全的作用，因为 f1 中的局部变量只有 f2 才能访问。

此外，闭包还在内存中维持了一个变量，所以在网页设计中，要注意对闭包的使用，不能滥用，避免产生内存泄漏的可能性。如果确定变量不用，需要把局部变量删除。

[参考资料](http://www.gracecode.com/posts/2385.html)
